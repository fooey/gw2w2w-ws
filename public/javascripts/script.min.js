/*! grunt-uglify gw2w2w-ws - v0.0.1 - 2014-01-09 */

/*!
*
*	LIB
*
*/
function reload(ms){waitingForReload||(waitingForReload=!0,console.log("Reloading in %d ms",ms),$("#priorityAlert").slideDown("fast"),setTimeout(function(){$("#priorityAlert").find("h3").fadeOut("fast",function(){$(this).remove()}),$.ajax({url:window.location,type:"head",timeout:3e3}).done(function(){window.location.reload()}).fail(function(){console.log("*********************************"),console.log(" App not ready, requeuing reload "),console.log("*********************************"),$("#priorityAlert").css({minHeight:"160px"}).append($("<h3>Application unavailable, requeuing page reload...</h3>").hide().fadeIn("fast")),waitingForReload=!1,reloadDelayed(4e3,8e3)})},ms))}function reloadDelayed(msMin,msMax){msMin&&!msMax?msMax=msMin:msMin||msMax||(msMax=msMax||100,msMin=msMin||300);var ms=ms||randRange(msMin,msMax);reload(ms)}function reloadNow(){reload(0)}function isJSON(data){var isJson=!1;try{var json=$.parseJSON(data);isJson="object"==typeof json}catch(ex){}return isJson}function minuteFormat(seconds){var minutes=Math.floor(seconds/60);seconds-=60*minutes,seconds="00"+seconds,seconds=seconds.substring(seconds.length-2,seconds.length);var txt=minutes+":"+seconds;return txt}function randRange(rangeMin,rangeMax){var randInRange=Math.round(Math.random()*(rangeMax-rangeMin)+rangeMin);return randInRange}/*!
*   LOG
*/
function initLog($log){console.log("initLog()"),$log.find(".logEntry").on("mouseenter",function(){var $that=$(this),objectiveId=$that.data("objectiveid"),$objective=$("#objective-"+objectiveId);$objective.addClass("active")}).on("mouseout",function(){var $that=$(this),objectiveId=$that.data("objectiveid"),$objective=$("#objective-"+objectiveId);$objective.removeClass("active")}),$log.find("#logtabs a").on("click",function(){var $that=$(this),mapName=$that.data("mapname");$that.closest("li").addClass("active").siblings().removeClass("active"),"All"===mapName?$log.find(".mapName:hidden").show().end().find(".logEntry:hidden").show().end():$log.find(".mapName:visible").hide().end().find(".logEntry:visible").hide().end().find(".logEntry."+mapName).show().end()})}function globalEvents(message){if(console.log("WS Global:",message),message.event)switch(message.event){case"desync":case"resync":case"reset":reloadDelayed()}}function overviewEvents(message){if(message.event&&"updateScore"===message.event){var eventArgs=message.arguments;console.log("update match scores",eventArgs.matchId);var $match=$("#match"+eventArgs.matchId);$match.find(".world").each(function(i){var $that=$(this),score=Humanize.intcomma(eventArgs.scores[i]);$that.find(".score").text(score)}),drawPie($match.find(".pie"))}}function trackerEvents(message){if(message.event&&"updateScore"===message.event){var eventArgs=message.arguments;console.log("update match scores",eventArgs.scores);var $scores=$(".totalScores .score");$scores.each(function(i){var score=Humanize.intcomma(eventArgs.scores[i]);$(this).text(score)})}else if(message.event&&"newOwner"===message.event){var eventArgs=message.arguments;console.log("update objective owner",eventArgs);var $objective=$("#objective-"+eventArgs.objectiveId),$sprite=$objective.find(".sprite");$objective.removeClass("red green blue neutral").addClass(eventArgs.owner.toLowerCase()).data("lastcaptured",eventArgs.timestamp),$sprite.removeClass("red green blue neutral").addClass(eventArgs.owner.toLowerCase())}}var dateFormat=function(){var token=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,timezone=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,timezoneClip=/[^-+\dA-Z]/g,pad=function(val,len){for(val=String(val),len=len||2;val.length<len;)val="0"+val;return val};return function(date,mask,utc){var dF=dateFormat;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(date)||/\d/.test(date)||(mask=date,date=void 0),date=date?new Date(date):new Date,isNaN(date))throw SyntaxError("invalid date");mask=String(dF.masks[mask]||mask||dF.masks["default"]),"UTC:"==mask.slice(0,4)&&(mask=mask.slice(4),utc=!0);var _=utc?"getUTC":"get",d=date[_+"Date"](),D=date[_+"Day"](),m=date[_+"Month"](),y=date[_+"FullYear"](),H=date[_+"Hours"](),M=date[_+"Minutes"](),s=date[_+"Seconds"](),L=date[_+"Milliseconds"](),o=utc?0:date.getTimezoneOffset(),flags={d:d,dd:pad(d),ddd:dF.i18n.dayNames[D],dddd:dF.i18n.dayNames[D+7],m:m+1,mm:pad(m+1),mmm:dF.i18n.monthNames[m],mmmm:dF.i18n.monthNames[m+12],yy:String(y).slice(2),yyyy:y,h:H%12||12,hh:pad(H%12||12),H:H,HH:pad(H),M:M,MM:pad(M),s:s,ss:pad(s),l:pad(L,3),L:pad(L>99?Math.round(L/10):L),t:12>H?"a":"p",tt:12>H?"am":"pm",T:12>H?"A":"P",TT:12>H?"AM":"PM",Z:utc?"UTC":(String(date).match(timezone)||[""]).pop().replace(timezoneClip,""),o:(o>0?"-":"+")+pad(100*Math.floor(Math.abs(o)/60)+Math.abs(o)%60,4),S:["th","st","nd","rd"][d%10>3?0:(d%100-d%10!=10)*d%10]};return mask.replace(token,function($0){return $0 in flags?flags[$0]:$0.slice(1,$0.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},Date.prototype.format=function(mask,utc){return dateFormat(this,mask,utc)};/*!
*
*   APP
*
*/
/*!
*   ONLOAD and BEHAVIORS
*/
var $overview,$tracker;$(function(){$overview=$(".overview"),$overview.length&&$overview.find(".pie").each(function(){drawPie($(this))}),$tracker=$("#tracker"),$tracker.length&&(updateTimers(),setInterval(updateTimers,1e3)),$log=$("#log"),$log.length&&initLog($log)});/*!
*   OVERVIEW
*/
var chartOptions={width:90,height:90,chartArea:{width:"100%",height:"100%"},colors:["#a94442","#31708f","#3c763d"],enableInteractivity:!1,pieSliceText:"none",legend:{position:"none"},tooltip:{textStyle:{fontSize:"9"}}},drawPie=function($pie){var $match=$pie.closest(".match"),matchId=$match.data("matchid"),$red=$match.find(".world.red"),redTeam=$red.find("a").text(),redScore=$red.find(".score").data("score")||0,$blue=$match.find(".world.blue"),blueTeam=$blue.find("a").text(),blueScore=$blue.find(".score").data("score")||0,$green=$match.find(".world.green"),greenTeam=$green.find("a").text(),greenScore=$green.find(".score").data("score")||0,chartData=google.visualization.arrayToDataTable([["Team","Score"],[redTeam,redScore],[blueTeam,blueScore],[greenTeam,greenScore]]);new google.visualization.PieChart(document.getElementById("pie"+matchId)).draw(chartData,chartOptions)},buffTimer=300,updateTimers=function(){var now=Math.floor(Date.now()/1e3);$tracker.find(".objective").each(function(){var $that=$(this),lastCaptured=$that.data("lastcaptured"),timeHeld=now-lastCaptured;buffTimer>timeHeld?$that.find(".timer").show().html(minuteFormat(buffTimer-timeHeld)):$that.find(".timer:visible").text("").hide()}),$("#logEntries .logEntry").each(function(){var $that=$(this),timestamp=$that.data("timestamp"),dateObj=new Date(1e3*timestamp),timeText=dateFormat(dateObj,"hh:mm:ss");$that.find(".timestamp").html(timeText)})},subscribeToUpdates=function(channel){var wsHost=["ws://",window.location.hostname,":",window.location.port].join(""),wsClient=new WebSocket(wsHost);console.log("Subscribing to channel",channel),wsClient.onopen=function(){var packet={event:"subscribe",channel:channel};console.log("WS Send:",packet),wsClient.send(JSON.stringify(packet))},wsClient.onclose=function(){reloadDelayed()},wsClient.onmessage=function(event){var packets=event.data;console.log("Recieved WS Message: ",packets),isJSON(packets)&&(packets=JSON.parse(packets)),Array.isArray(packets)||(packets=[packets]),_.forEach(packets,function(packet){if(!packet.event||"resync"!==packet.event&&"desync"!==packet.event)switch(channel){case"global":case"loading":globalEvents(packet);break;case"overview":overviewEvents(packet);break;default:trackerEvents(packet)}else globalEvents(packet)})}},waitingForReload=!1,$alertDiv;$(function(){$('<div id="priorityAlert" class="alert alert-danger" style="margin: 1em 0; padding: 1em; text-align: center; vertical-align: middle;"><h1>Application has requested a page reload</h1></div>').hide().prependTo("#content")});